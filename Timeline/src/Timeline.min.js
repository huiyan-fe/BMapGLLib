let BMapGLLib=window.BMapGLLib||{};const prefix="BMapGLLib";class Timeline{constructor(t){this.options=t,this.listeners={},this._interval=t.interval||1e3,this._playTimeId=null,this._playStatus="pause",this._startX,this._progressMax=0,this._playIndex=0,this._progress=0,this._steps=[],this._times=t.times||[],this._ctx=document.createElement("canvas").getContext("2d"),this._startScrollIndex=-1,this._scrollIndex=1,this._container=null,this._playButton=t.playButton||document.createTextNode("播放"),this._pauseButton=t.pauseButton||document.createTextNode("暂停"),this._initDom(t),this._drawTime()}_initDom(){if(this.element=document.createElement("div"),this.element.className=prefix+"-timeline",this.options.className&&(this.element.className+=" "+this.options.className),this._startButton=document.createElement("div"),this._startButton.className=prefix+"-timeline-play",this._startButton.innerHTML="",this._startButton.appendChild(this._playButton),this.element.appendChild(this._startButton),this._scrollDiv=document.createElement("div"),this._scrollDiv.className=prefix+"-timeline-main",this.element.appendChild(this._scrollDiv),this._ul=document.createElement("ul"),this._scrollDiv.appendChild(this._ul),this._progressDiv=document.createElement("div"),this._progressDiv.className=prefix+"-timeline-progress",this.options.progressButtonStyle&&this._applyStyle(this._progressDiv,this.options.progressButtonStyle),this._scrollDiv.appendChild(this._progressDiv),this._onPlayChange=this._onPlayChange.bind(this),this._onProgressDragStart=this._onProgressDragStart.bind(this),this._onProgressDrag=this._onProgressDrag.bind(this),this._onProgressDragEnd=this._onProgressDragEnd.bind(this),this._startButton.addEventListener("click",this._onPlayChange),this._progressDiv.addEventListener("mousedown",this._onProgressDragStart),this.options.customContainer)this._container=this.options.customContainer,this.options.customContainer.appendChild(this.element);else{if(!this.options.map)throw new Error("options.map or options.customContainer is required");this._container=this.options.map.getContainer(),this.options.map.getContainer().appendChild(this.element)}this._startX=this._scrollDiv.getBoundingClientRect().left}on(t,s){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(s)}un(t,s){this.listeners[t]&&-1<(s=this.listeners[t].indexOf(s))&&this.listeners[t].splice(s,1)}dispatchEvent(s){if(this.listeners[s.type])for(let t=0;t<this.listeners[s.type].length;t++)this.listeners[s.type][t](s)}pause(){"pause"!==this._playStatus&&this._onPlayChange()}play(){"play"!==this._playStatus&&this._onPlayChange()}_drawTime(){let s=0,e=0;for(let t=0;t<this._times.length;t++){var i=this._times[t],n=document.createElement("li"),r=document.createElement("div"),a=document.createElement("span"),h=(a.innerText=i,this.options.timeStyle&&this._applyStyle(a,this.options.timeStyle),n.appendChild(r),n.appendChild(a),r.className=prefix+"-time-item",0===t&&(r.className=`${prefix}-time-item ${prefix}-time-start`),t===this._times.length-1&&(r.className=`${prefix}-time-item ${prefix}-time-end`),this.options.scrollStyle&&this._applyStyle(r,this.options.scrollStyle),document.createElement("div")),h=(h.className=prefix+"-time-divider",this.options.dividerStyle&&this._applyStyle(h,this.options.dividerStyle),n.appendChild(h),this._ul.appendChild(n),this._ctx.font=getComputedStyle(a).font,this._ctx.measureText(i).width),n=h+16,a=(r.style.width=n+"px",n/2),h=(e+=n,{time:i,start:s,end:e-a,index:t});s=e-a+1,this._steps.push(h)}this._progressMax=e,this._calcStartScrollIndex()}_calcStartScrollIndex(){var s=this._scrollDiv.clientWidth;let e=0;for(let t=0;t<this._steps.length-1;t++)if(this._steps[t].end>s){e=t;break}this._startScrollIndex=e}_onProgressDrag(t){t=t.clientX-this._startX+this._scrollDiv.scrollLeft;0<=t&&t<=this._progressMax&&this._updateProgress(t)}_onProgressDragEnd(t){t=t.clientX-this._startX,t=this._getStepByProgress(t);t?(this.dispatchEvent({type:"change",time:t.time}),this._playIndex=t.index):this._playIndex=this._steps.length,document.removeEventListener("mousemove",this._onProgressDrag),document.removeEventListener("mouseup",this._onProgressDragEnd)}_onProgressDragStart(t){clearTimeout(this._playTimeId),this._playStatus="pause",this._startButton.innerHTML="",this._startButton.appendChild(this._playButton),document.addEventListener("mousemove",this._onProgressDrag),document.addEventListener("mouseup",this._onProgressDragEnd)}_onPlayChange(){var t;if(this._playTimeId&&clearTimeout(this._playTimeId),this._playIndex>=this._steps.length?(this._playIndex=0,this._scrollIndex=1,this._scrollDiv.scrollLeft=0,this._progressDiv.style.left=0):(t=this._getStepByProgress(this._progress),this._playIndex=t?t.index:this._steps.length),"pause"===this._playStatus){this.dispatchEvent({type:"playstart"});const s=()=>{this._playTimeId=setTimeout(s,this._interval);var t=this._steps[this._playIndex++];t&&this._updateProgressByStep(t),this._playIndex>=this._steps.length&&(clearTimeout(this._playTimeId),this._playStatus="pause",this._startButton.innerHTML="",this._startButton.appendChild(this._playButton),this.dispatchEvent({type:"playend"}))};this._playTimeId=setTimeout(s,this._interval),this._playStatus="play",this._startButton.innerHTML="",this._startButton.appendChild(this._pauseButton)}else this._playStatus="pause",this._startButton.innerHTML="",this._startButton.appendChild(this._playButton),this.dispatchEvent({type:"playend"}),clearTimeout(this._playTimeId)}_updateProgressByStep(t){this.dispatchEvent({type:"change",time:t.time}),this._progress=t.end,this._progressDiv.style.left=this._progress-5+"px",0<this._startScrollIndex&&t.end>=this._steps[this._startScrollIndex].end&&(this._scrollDiv.scrollLeft=this._steps[this._scrollIndex++].end)}_getStepByProgress(s){for(let t=0;t<this._steps.length;t++){var e=this._steps[t];if(e.start<=s&&e.end>=s)return e}}_updateProgress(t){this._progress=t,this._progressDiv.style.left=t+"px"}_applyStyle(t,s){for(var e in s)t.style[e]=s[e]}destroy(){this._startButton.removeEventListener("click",this._onPlayChange),this._progressDiv.removeEventListener("mousedown",this._onProgressDragStart),this._container.removeChild(this.element)}}BMapGLLib.Timeline=Timeline;